---
title: "Análisis de Redes - Tesis de Jurisprudencia"
output: html_document
date: '2022-08-16'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

## Análisis de Redes - Tesis de Jurisprudencia

Comenzamos cargando librerías y los datos correspondientes:

```{r}
library(tidyverse)
library(tidygraph)
library(ggraph)
library(igraphdata)
total <- read.csv("../output/tesis_secr_expand_rep.csv")
socio <- read.csv("../data/sociodemo/X1_Sociodemograficos_1.csv")
dim(total)
dim(socio)
```

Contamos nombres únicos:

```{r}
count(distinct(total, ponente))
count(distinct(total, secretario))
```

Hacemos relación de nombres con IDs:

```{r}
set.seed(2022)

# Primero limpiamos nombres:
total_1 <- total %>% select(id_tesis, X._reiteracion, instancia, epoca, materia, fecha, ponente, 
                              S1, S2, S3, S4, S5, S6, ponente_rep) %>%
  mutate(id_tesis = as.character(id_tesis)) %>%
  
  mutate(ponente_clean = str_to_lower(ponente)) %>%
  mutate(ponente_clean = str_replace_all(ponente_clean, " ", "")) %>%
  mutate(ponente_clean = str_replace_all(ponente_clean, "[[:punct:]]", "")) %>%
  mutate(ponente_clean = chartr('áéíóú','aeiou', ponente_clean)) %>%
  
  mutate(S1_clean = str_to_lower(S1))  %>%
  mutate(S1_clean = str_replace_all(S1_clean, " ", "")) %>%
  mutate(S1_clean = str_replace_all(S1_clean, "[[:punct:]]", "")) %>%
  mutate(S1_clean = chartr('áéíóú','aeiou', S1_clean)) %>% 
  
  mutate(S2_clean = str_to_lower(S2))  %>%
  mutate(S2_clean = str_replace_all(S2_clean, " ", "")) %>%
  mutate(S2_clean = str_replace_all(S2_clean, "[[:punct:]]", "")) %>%
  mutate(S2_clean = chartr('áéíóú','aeiou', S2_clean)) %>% 
  
  mutate(S3_clean = str_to_lower(S3))  %>%
  mutate(S3_clean = str_replace_all(S3_clean, " ", "")) %>%
  mutate(S3_clean = str_replace_all(S3_clean, "[[:punct:]]", "")) %>%
  mutate(S3_clean = chartr('áéíóú','aeiou', S3_clean)) %>% 
  
  mutate(S4_clean = str_to_lower(S4))  %>%
  mutate(S4_clean = str_replace_all(S4_clean, " ", "")) %>%
  mutate(S4_clean = str_replace_all(S4_clean, "[[:punct:]]", "")) %>%
  mutate(S4_clean = chartr('áéíóú','aeiou', S4_clean)) %>% 
  
  mutate(S5_clean = str_to_lower(S5))  %>%
  mutate(S5_clean = str_replace_all(S5_clean, " ", "")) %>%
  mutate(S5_clean = str_replace_all(S5_clean, "[[:punct:]]", "")) %>%
  mutate(S5_clean = chartr('áéíóú','aeiou', S5_clean)) %>% 
  
  mutate(S6_clean = str_to_lower(S6))  %>%
  mutate(S6_clean = str_replace_all(S6_clean, " ", "")) %>%
  mutate(S6_clean = str_replace_all(S6_clean, "[[:punct:]]", "")) %>%
  mutate(S6_clean = chartr('áéíóú','aeiou', S6_clean)) 

# Agregamos identificadores únicos para ponentes:
total_1$id_ponente <- total_1 %>% group_indices(ponente_clean)
total_1 <- transform(total_1, id_ponente = as.character(id_ponente))

# Creamos dataframe con nombres únicos de ponentes:
ponentes <- total_1 %>%
  select(ponente, ponente_clean, id_ponente)
ponentes <- ponentes[!duplicated(ponentes$id_ponente), ]
colnames(ponentes)[colnames(ponentes) == "id_ponente"] <- "id"
ponentes <- transform(ponentes, id = as.character(id))

# Creamos dataframe para nombres únicos de secretarios:
secretarios <- setNames(data.frame(c(total_1$S1, total_1$S2, total_1$S3, 
                                      total_1$S4, total_1$S5, total_1$S6)), "secretario")
secretarios$secretario_clean <- c(total_1$S1_clean, total_1$S2_clean, total_1$S3_clean, 
                                   total_1$S4_clean, total_1$S5_clean, total_1$S6_clean)
secretarios <- secretarios[!duplicated(secretarios$secretario_clean), ]
secretarios$id <- seq.int(nrow(secretarios)) 
secretarios <- transform(secretarios, id = as.character(id))

# Seleccionamos columnas de datos sociodemográficos:
socio_1 <- socio %>% 
  select(id = id_final, name, nombres_clean)
```

Definimos funciones:

```{r}
calcular_tejas <- function(x, k = 4, lowercase = FALSE){
  tokenizers::tokenize_character_shingles(x, n = k, lowercase = lowercase,
    simplify = TRUE, strip_non_alpha = FALSE)
}

generar_hash <- function(){
  r <- as.integer(stats::runif(1, 1, 2147483647))
  funcion_hash <- function(tejas){
        digest::digest2int(tejas, seed = r) 
  }
  funcion_hash
}

construir_firmas <- function(hashes, tejas){
  tibble(hash_num = 1:length(hashes), 
         firma = map_int(hashes, \(h) min(h(tejas)))
  )
}

sim_jaccard <- \(a, b)  length(intersect(a, b)) / length(union(a, b))
```

Hacemos tejas para cada lista:

```{r}
# Tejas para nombres de ponentes:
ponente_tejas <- ponentes %>% 
  mutate(tejas = map(ponente_clean, ~ calcular_tejas(.x, k = 5)))

# Tejas para nombres de secretarios:
secretario_tejas <- secretarios %>% 
  mutate(tejas = map(secretario_clean, ~ calcular_tejas(.x, k = 5)))

# Tejas de datos sociodemográficos:
socio_tejas <- socio_1 %>% 
  mutate(tejas = map(nombres_clean, ~ calcular_tejas(.x, k = 5)))
```

Calculamos minhashes:

```{r}
# Crearemos 2 hashes por nombre:
hashes <- map(1:2, ~ generar_hash())

# Minhashes de ponentes:
ponente_firmas <- ponente_tejas %>% 
  mutate(firma = map(tejas, ~ construir_firmas(hashes, .x))) %>%
  select(id, firma) %>%
  unnest(firma) %>%
  mutate(cubeta = paste(hash_num, firma, sep = "-")) %>%
  select(id, cubeta)

# Minhashes de secretarios:
secretario_firmas <- secretario_tejas %>% 
  mutate(firma = map(tejas, ~ construir_firmas(hashes, .x))) %>%
  select(id, firma) %>%
  unnest(firma) %>%
  mutate(cubeta = paste(hash_num, firma, sep = "-")) %>%
  select(id, cubeta)

# Minhashes de datos sociodemográficos:
socio_firmas <- socio_tejas %>%
  mutate(firma = map(tejas, ~ construir_firmas(hashes, .x))) %>%
  select(id, firma) %>%
  unnest(firma) %>%
  mutate(cubeta = paste(hash_num, firma, sep = "-")) %>%
  select(id, cubeta)
```

Hacemos una unión por cubetas para obtener nuestros pares candidatos:

```{r}
# Candidatos de ponentes:
ponente_candidatos_tbl <- inner_join(socio_firmas %>% rename(id_socio = id), 
                                     ponente_firmas %>% rename(id_ponente = id))

# Candidatos de secretarios:
secretario_candidatos_tbl <- inner_join(socio_firmas %>% rename(id_socio = id), 
                                     secretario_firmas %>% rename(id_secretario = id))
```

Calculamos similitud exacta para candidatos

```{r}
# Similitud para ponentes:
ponente_candidatos_score_tbl <- ponente_candidatos_tbl %>%
  left_join(socio_tejas %>%
              select(id_socio = id, tejas_socio = tejas)) %>%
  left_join(ponente_tejas %>%
              select(id_ponente = id, tejas_ponente = tejas)) %>%
  mutate(score = map2_dbl(tejas_socio, tejas_ponente, ~ sim_jaccard(.x, .y))) %>%
  select(-tejas_socio, -tejas_ponente, -cubeta)

ponente_candidatos_score_tbl <- ponente_candidatos_score_tbl %>%
  unique()

ponente_candidatos_score_tbl
```

```{r}
# Similitud para secretarios:
secretario_candidatos_score_tbl <- secretario_candidatos_tbl %>%
  left_join(socio_tejas %>%
              select(id_socio = id, tejas_socio = tejas)) %>%
  left_join(secretario_tejas %>%
              select(id_secretario = id, tejas_secretario = tejas)) %>%
  mutate(score = map2_dbl(tejas_socio, tejas_secretario, ~ sim_jaccard(.x, .y))) %>%
  select(-tejas_socio, -tejas_secretario, -cubeta)

secretario_candidatos_score_tbl <- secretario_candidatos_score_tbl %>%
  unique()

secretario_candidatos_score_tbl
```

Proponemos puntos de corte:

```{r}
# Punto de corte para ponentes:
ponente_candidatos_filt <- filter(ponente_candidatos_score_tbl, score > 0.6) %>%
  left_join(socio_1 %>%
              select(id_socio = id, name)) %>%
  left_join(ponentes %>%
              select(id_ponente = id, ponente)) %>%
  arrange(-score)

tail(ponente_candidatos_filt)
nrow(ponentes)
nrow(ponente_candidatos_filt)
```

```{r}
# Punto de corte para secretarios:
secretario_candidatos_filt <- filter(secretario_candidatos_score_tbl, score > 0.55) %>%
  left_join(socio_1 %>%
              select(id_socio = id, name)) %>%
  left_join(secretarios %>%
              select(id_secretario = id, secretario)) %>%
  arrange(-score)

tail(secretario_candidatos_filt)
nrow(secretarios)
nrow(secretario_candidatos_filt)
```

Si queremos examinar candidatos específicos:

```{r}
# Candidatos con score de 1:

# Nombre en lista de datos sociodemográficos:
socio_1 %>% filter_at(vars(id), any_vars(. %in% c('AAJ_3982')))

# Nombre de ponente:
ponentes %>% filter_at(vars(id), any_vars(. %in% c('766')))
```

Agregamos el ID sociodemográfico a los datos y eliminamos registros nulos:

```{r}
# Creamos dataframe con ID sociodemográfico y nombres limpios para secretarios:
secretarios_id <- secretarios %>%
  left_join(secretario_candidatos_filt) %>%
  select(-id_secretario, -score, -name)

# Agregamos ID sociodemográfico a ponentes:
total_id <- total_1 %>% 
  left_join(ponente_candidatos_filt) %>%
  rename(id_ponente_socio = id_socio) %>%
  select(-score, -name) %>%
  unique()

# Agregamos ID sociodemográfico a secretarios:
total_id <- total_id %>%
  #S1:
  rename(secretario_clean = S1_clean) %>%
  left_join(secretarios_id) %>%
  select(-secretario, -id) %>%
  rename(S1_clean = secretario_clean, id_S1_socio = id_socio) %>%
  unique() %>%
  #S2:
  rename(secretario_clean = S2_clean) %>%
  left_join(secretarios_id) %>%
  select(-secretario, -id) %>%
  rename(S2_clean = secretario_clean, id_S2_socio = id_socio) %>%
  unique() %>%
  #S3:
  rename(secretario_clean = S3_clean) %>%
  left_join(secretarios_id) %>%
  select(-secretario, -id) %>%
  rename(S3_clean = secretario_clean, id_S3_socio = id_socio) %>%  
  unique() %>%
  #S4:
  rename(secretario_clean = S4_clean) %>%
  left_join(secretarios_id) %>%
  select(-secretario, -id) %>%
  rename(S4_clean = secretario_clean, id_S4_socio = id_socio) %>% 
  unique() %>%
  #S5:
  rename(secretario_clean = S5_clean) %>%
  left_join(secretarios_id) %>%
  select(-secretario, -id) %>%
  rename(S5_clean = secretario_clean, id_S5_socio = id_socio) %>% 
  unique() %>%
  #S6:
  rename(secretario_clean = S6_clean) %>%
  left_join(secretarios_id) %>%
  select(-secretario, -id) %>%
  rename(S6_clean = secretario_clean, id_S6_socio = id_socio) %>%
  unique()

total_id <- total_id %>%
  unique()

# Agregamos identificador de repetición a ponentes:
total_id <- total_id %>%
  mutate(id_ponente_socio_rep = case_when(grepl(".*_REP", ponente_rep) & 
                                      id_ponente_socio != is.na(id_ponente_socio) 
                                      ~ paste0(id_ponente_socio, "_REP"),
                                    TRUE ~ id_ponente_socio))

# Eliminamos registros sin ponente:
total_id_nona <- total_id %>% 
  drop_na(ponente) %>%
  arrange(id_tesis, X._reiteracion)
```

Comparamos número de tesis totales contra las tesis de las que tenemos datos de ponentes/secretarios:

```{r}
# Número de tesis totales:
length(unique(total_id$id_tesis))

# Número de tesis de las que tenemos datos de ponentes/secretarios:
length(unique(total_id_nona$id_tesis))
```

Si eliminamos reiteraciones a sí mismos:

```{r}
unico <- total %>% select(id_tesis, ponente, secretario)
unico <- unico %>% distinct(id_tesis, ponente, .keep_all = TRUE)
unico <- unico %>% distinct(id_tesis, secretario, .keep_all = TRUE)

dim(unico)
```

**Red Ponentes-Secretarios**

```{r}

#Cremamos df con info necesaria:
pon_sec_df <- total_id_nona %>% 
  pivot_longer(cols = names(total_id_nona)[24:29],
                    values_to = "id_secretario_socio") %>% 
  select(id_ponente_socio_rep,id_secretario_socio,epoca) %>% 
  drop_na(id_secretario_socio) %>% 
  drop_na(id_ponente_socio_rep) 

# Agregamos identificador único:
pon_sec_df$from <- pon_sec_df %>% group_indices(id_ponente_socio_rep)
pon_sec_df$to <- pon_sec_df %>% group_indices(id_secretario_socio)

# Creamos nodos:
nodos_pon_sec <- pon_sec_df[, c("id_ponente_socio_rep","from","epoca")]
colnames(nodos_pon_sec) <- c("nodos", "id","epoca")

# Creamos aristas:
aristas_pon_sec <- pon_sec_df[, c("from","to")]

# Creamos red:
red_pon_sec <- tbl_graph(nodes = nodos_pon_sec, 
                  edges = aristas_pon_sec, 
                  directed = TRUE)

# Agregamos medidas de intermediación y centralidad
red_pon_sec <- red_pon_sec %>% 
  activate(nodes) %>% 
  mutate(intermediacion = centrality_betweenness(),
         central_pagerank = centrality_pagerank())

red_pon_sec
```

**Red Ponentes-Ponentes-1, usando todos los registros**

```{r}
#Cremamos df con info necesaria:
pon_pon1_df <- total_id_nona %>%
  select(id_tesis,X._reiteracion,epoca,ponente_rep)

# Agregamos identificador único:
pon_pon1_df$id_ponente <- pon_pon1_df %>% group_indices(ponente_rep)

# Hacemos combinatorias de 2 ponentes por tesis
comb_pon_pon1 <- pon_pon1_df %>%
  group_by(id_tesis) %>%
  summarise(comb = t(combn(id_ponente, 2)))
comb_pon_pon1 <- data.frame(id_tesis=comb_pon_pon1[1], from=comb_pon_pon1$comb[,1], to=comb_pon_pon1$comb[,2])

# Agregamos Época de acuerdo al dataframe original
comb_pon_pon1$epoca <- pon_pon1_df[match(comb_pon_pon1$id_tesis,pon_pon1_df$id_tesis),"epoca"]

# Creamos nodos:
nodos_pon_pon1 <- pon_pon1_df[, c("id_ponente","epoca")]
  
# Creamos aristas:
aristas_pon_pon1 <- comb_pon_pon1 %>%
  select(to,from)

# Creamos red:
red_pon_pon1 <- tbl_graph(nodes = nodos_pon_pon1, 
                  edges = aristas_pon_pon1, 
                  directed = TRUE)

# Agregamos medidas de intermediación y centralidad
red_pon_pon1 <- red_pon_pon1 %>% 
  activate(nodes) %>% 
  mutate(intermediacion = centrality_betweenness(),
         central_pagerank = centrality_pagerank())

red_pon_pon1
```

**Red Ponentes-Ponentes-2, usando sólo tesis con ID sociodemográfico para TODOS sus ponentes**

```{r}
#Cremamos df con info necesaria:
pon_pon2_df <- total_id_nona %>%
  group_by(id_tesis) %>%
  filter(!any(id_ponente_socio_rep == "NA")) %>%
  select(id_tesis,X._reiteracion,epoca,id_ponente_socio_rep)

# Agregamos identificador único:
pon_pon2_df$id_ponente <- pon_pon2_df %>% group_indices(id_ponente_socio_rep)

# Hacemos combinatorias de 2 ponentes por tesis
comb_pon_pon2 <- pon_pon2_df %>%
  group_by(id_tesis) %>%
  summarise(comb = t(combn(id_ponente, 2)))
comb_pon_pon2 <- data.frame(id_tesis=comb_pon_pon2[1], from=comb_pon_pon2$comb[,1], to=comb_pon_pon2$comb[,2])

# Agregamos Época de acuerdo al dataframe original
comb_pon_pon2$epoca <- pon_pon2_df[match(comb_pon_pon2$id_tesis,pon_pon2_df$id_tesis),"epoca"]

# Creamos nodos:
nodos_pon_pon2 <- pon_pon2_df[, c("id_ponente","id_ponente_socio_rep","epoca")]
  
# Creamos aristas:
aristas_pon_pon2 <- comb_pon_pon2 %>%
  select(to,from)

# Creamos red:
red_pon_pon2 <- tbl_graph(nodes = nodos_pon_pon2, 
                  edges = aristas_pon_pon2, 
                  directed = TRUE)

# Agregamos medidas de intermediación y centralidad
red_pon_pon2 <- red_pon_pon2 %>% 
  activate(nodes) %>% 
  mutate(intermediacion = centrality_betweenness(),
         central_pagerank = centrality_pagerank())

red_pon_pon2
```

Creamos funciones para graficar redes:

```{r,}

graficar_red <- function(red,layout_red,tamaño,color,etiqueta,title){
  red %>%
    activate(nodes) %>% 
    ggraph(layout = layout_red) + 
    geom_edge_link(colour = "gray", arrow = arrow(length = unit(2, 'mm'))) + 
    geom_node_point(aes(size = (!!as.name(tamaño)), colour = (!!as.name(color))), alpha = 0.7) +
    geom_node_text(aes(label = (!!as.name(etiqueta))), repel = T, size = 2)  +
    theme_graph(base_family = "sans") + 
    ggtitle(title)
}

# Filtrando por alguna columna
graficar_red_filtro <- function(red,filtro,filtro_param,layout_red,tamaño,color,etiqueta,title){
  red %>%
    activate(nodes) %>% 
    filter((!!as.name(filtro)) == filtro_param) %>%
    ggraph(layout = layout_red) + 
    geom_edge_link(colour = "gray", arrow = arrow(length = unit(2, 'mm'))) + 
    geom_node_point(aes(size = (!!as.name(tamaño)), colour = (!!as.name(color))), alpha = 0.7) +
    geom_node_text(aes(label = (!!as.name(etiqueta))), repel = T, size = 2)  +
    theme_graph(base_family = "sans") + 
    ggtitle(title)
}
```

Visualizamos red

```{r, fig.width = 8, fig.height=6}
graficar_red_filtro(red_pon_sec,'epoca','Décima Época','drl','intermediacion','central_pagerank','nodos','Pon-Sec: Décima Época')
```

```{r, fig.width = 8, fig.height=6}
graficar_red(red_pon_pon2,'drl','intermediacion','central_pagerank','id_ponente_socio_rep','Pon-Pon2 (sólo con id socio)')
```

```{r, fig.width = 8, fig.height=6}
red_pon_pon2 %>%
  activate(nodes) %>% 
  filter(intermediacion >= 10000) %>%
  #filter(central_pagerank >= 0.0004) %>%
  ggraph(layout = 'drl') + 
  geom_edge_link(colour="gray", arrow = arrow(length = unit(2, 'mm'))) + 
  geom_node_point(aes(size= intermediacion, colour=central_pagerank)) +
  geom_node_text(aes(label = id_ponente_socio_rep), repel=T, size=2) +
  theme_graph(base_family="sans") + 
  ggtitle('Pon-Pon2 (sólo con id socio) filtrado')
```

```{r, fig.width = 8, fig.height=6}
```

```{r, fig.width = 8, fig.height=6}
```
